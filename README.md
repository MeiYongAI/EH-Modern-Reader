# EH Modern Reader

> 现代化的 E-Hentai 阅读器浏览器扩展

![Version](https://img.shields.io/badge/version-1.2.0-blue)
![License](https://img.shields.io/badge/license-MIT-green)

## 📖 简介

EH Modern Reader 是一个为 E-Hentai / ExHentai 站点设计的现代化阅读器扩展，完全替代原版 MPV 阅读器，提供流畅、优雅的阅读体验。

### ✨ 核心特性

#### 🎨 界面与交互
- **现代化 UI 设计** - 简洁优雅的深色/浅色主题自动适配
- **双阅读模式** - 单页模式 & 横向连续滚动模式
- **响应式布局** - 完美适配各种屏幕尺寸
- **完美居中缩略图** - 真实图片预览，垂直水平双向居中（v1.2.0）

#### 🖼️ 缩略图系统（v1.2.0 重大升级）
- **即时占位预览** - 固定尺寸容器 + 雪碧图背景，零延迟展示
- **真实图片缩略图** - 独立生成，完美居中，无顶部空白
- **智能懒加载** - 600px 提前触发，流畅滚动体验
- **高性能渲染** - Canvas 绘制，contain 缩放，保持画面比例

#### ⚡ 性能优化
- **智能预加载系统**
  - 可配置预加载页数（默认 2 页）
  - 并发控制（最多 2 个并发请求）
  - 防抖与请求取消机制
  - 进度条拖动时预热目标页
- **多级缓存机制**
  - 真实图片 URL 缓存（减少页面解析）
  - 图片加载结果缓存（避免重复请求）
  - 加载中请求复用（防止重复加载）
- **横向模式懒加载**
  - IntersectionObserver 视口检测
  - 600px 提前加载距离（v1.2.0 优化）
  - 智能加载状态管理

#### 🖱️ 交互体验
- **三区点击导航**（v1.2.0）
  - 左侧 1/3：向左翻页
  - 中间 1/3：切换顶栏显示/隐藏
  - 右侧 1/3：向右翻页
- **滚轮操作**
  - 单页模式：滚轮前后翻页
  - 横向模式：垂直滚轮映射为水平滚动 + 预测性预加载
- **进度跳转优化**
  - 横向模式进度条/页码输入 = 瞬时跳转（立即定位 + 主动加载）
  - 键盘/缩略图导航 = 平滑滚动（保持连续性）
- **自动播放功能**
  - 单页模式：定时翻页（可调间隔 0.1-120s）
  - 横向模式：持续水平滚动（可调速度 0.1-100 px/帧）
  - Alt+单击自动按钮设置参数

#### 🛡️ 稳定性增强（v1.2.0）
- **强化初始化** - 三层兜底机制，6秒等待 + HTML 回退解析
- **CORS 优化** - 避免 Canvas 污染，直接插入节点
- **收窄设置面板** - 360px 最大宽度，更适合小屏设备

#### 💾 进度与历史
- **智能进度记录** - 每个画廊独立保存
  - 最后阅读页码
  - 阅读模式（单页/横向）
  - 横向模式滚动位置
  - 阅读时间戳
- **自动恢复** - 再次访问时恢复上次状态
- **历史列表** - 维护最近 200 条阅读记录

#### ⌨️ 快捷键支持
- 翻页导航：← / → / A / D / 空格
- 快速跳转：Home / End
- 自动播放：P
- 全屏控制：F11
- 面板管理：Esc

---

## 🚀 安装方法

### Chrome / Edge

1. 下载或克隆此项目到本地
2. 打开浏览器扩展管理页面
   - Chrome: `chrome://extensions/`
   - Edge: `edge://extensions/`
3. 开启右上角的 **"开发者模式"**
4. 点击 **"加载已解压的扩展程序"**
5. 选择项目文件夹 `eh-reader-extension`
6. 完成！访问 E-Hentai MPV 页面即可自动启用

### Firefox

1. 下载或克隆此项目到本地
2. 打开 `about:debugging#/runtime/this-firefox`
3. 点击 **"临时载入附加组件"**
4. 选择项目中的 `manifest.json` 文件
5. 完成！扩展将在 E-Hentai MPV 页面自动生效

---

## 📋 使用指南

### 界面布局

```
┌──────────────────────────────────────────────────────┐
│  [返回] 标题                页码    [自动][设置][全屏] │ ← 顶部栏
├────────┬─────────────────────────────────────────────┤
│        │                                             │
│ 缩略图  │            主图片显示区域                    │ ← 主内容
│ 列表    │      [← 当前图片 →]  或  [横向连续滚动]      │
│        │                                             │
├────────┴─────────────────────────────────────────────┤
│  进度条: ════════●════════                            │ ← 底部控制
│  [⏮] [页码输入框] [⏭]                                │
└──────────────────────────────────────────────────────┘
```

### 快捷键一览

| 按键 | 功能 | 说明 |
|------|------|------|
| `←` / `A` | 上一页 | 单页模式切页/横向模式平滑滚动 |
| `→` / `D` / `空格` | 下一页 | 单页模式切页/横向模式平滑滚动 |
| `Home` | 跳转首页 | 立即定位到第 1 页 |
| `End` | 跳转末页 | 立即定位到最后一页 |
| `P` | 自动播放 | 切换自动翻页/滚动 |
| `F11` | 全屏 | 进入/退出全屏模式 |
| `Esc` | 关闭面板 | 关闭设置面板/退出全屏 |

### 鼠标/触控操作

#### 三区点击导航（v1.2.0 新增）
- **点击左侧 1/3** - 向左翻页
- **点击中间 1/3** - 切换顶栏显示/隐藏
- **点击右侧 1/3** - 向右翻页
- 适用于所有模式，覆盖整个视图区域

#### 单页模式
- **滚轮上下** - 前后翻页
- **点击缩略图** - 跳转到指定页
- **拖动进度条** - 预热目标页，松手跳转

#### 横向连续模式
- **滚轮上下** - 自动映射为水平滚动 + 预测性预加载（v1.2.0 优化）
- **点击缩略图/进度条** - 瞬时跳转到目标页
- **自然滚动** - 自动识别当前页并更新高亮

### 设置选项

| 选项 | 说明 | 默认值 |
|------|------|--------|
| **预加载页数** | 向后预加载的页数（0-10） | 2 |
| **阅读模式** | 单页 / 横向连续 | 单页 |
| **自动播放间隔** | 单页模式翻页间隔（0.1-120秒） | 3s |
| **自动滚动速度** | 横向模式滚动速度（0.1-100 px/帧） | 0.5 |

💡 **提示**：
- 设置面板已优化为更紧凑的 360px 宽度（v1.2.0）
- Alt+单击"自动播放"按钮可快速调整间隔/速度
- 所有设置实时生效，无需刷新

### 导航行为差异

#### 进度条与页码输入
- **单页模式** - 直接加载目标页
- **横向模式** - 瞬时跳转（无动画，立即定位并主动加载目标页及前后 1-2 页）

#### 键盘与缩略图
- **单页模式** - 逐页切换
- **横向模式** - 平滑滚动到目标位置

> 设计理念：进度条跳转追求速度，键盘/缩略图导航保持连续性

### 进度记录说明

**自动保存内容**（每个画廊独立）
- 最后阅读页码
- 当前阅读模式
- 横向模式的滚动位置
- 最后访问时间戳

**自动恢复策略**
1. 检测到已保存进度时自动恢复阅读模式
2. 横向模式优先恢复滚动位置，否则瞬跳到保存页码
3. 单页模式直接跳转到保存页码

**历史管理**
- 维护最近 200 条阅读记录（LRU）
- 存储在 localStorage（`eh-reading-history`）
- 后续版本将提供历史列表 UI

---

## 🛠️ 技术实现

### 架构设计

```
┌─────────────────────────────────────┐
│  content.js (核心逻辑)               │
│  - 早期脚本拦截与变量捕获             │
│  - 真实 URL 解析与缓存               │
│  - 图片预加载队列（并发控制）         │
│  - 双模式渲染（单页/横向连续）        │
│  - 进度记录与恢复                    │
└─────────────────────────────────────┘
         ↓ 注入时机: document_start
┌─────────────────────────────────────┐
│  E-Hentai MPV 页面                   │
│  - 拦截原始脚本执行                   │
│  - 捕获 imagelist / gid / mpvkey     │
│  - 完全重写 DOM 结构                 │
└─────────────────────────────────────┘
```

### 核心机制

#### 1. 早期脚本拦截与兜底解析（v1.2.0 强化）
```javascript
// document_start 阶段覆写 appendChild/insertBefore
// 拦截内联脚本，解析并缓存 imagelist / gid / mpvkey
// 三层兜底：早期捕获 → 延迟重试（6秒）→ fetch HTML 解析
// 阻止原版 MPV 加载
```

#### 2. 真实 URL 解析
```javascript
// /s/<hash>/<gid>-<page> → 解析 HTML → 提取图片 URL
// 缓存: realUrlCache (hash → url)
// 去重: realUrlRequests (防止重复请求)
```

#### 3. 预取队列
```javascript
// 并发上限: 2
// 可取消: AbortController
// 优先级: 进度条拖动预热 > 正常预取
// 状态管理: loaded / loading / error
```

#### 4. 缩略图系统（v1.2.0 重构）
```javascript
// 固定占位 + 雪碧图快速预览（零延迟）
// IntersectionObserver (rootMargin: 600px)
// 真实图片 Canvas 绘制（contain 缩放 + 居中）
// 加载后清除背景，替换为最终缩略图
```

#### 5. 横向模式懒加载
```javascript
// IntersectionObserver (rootMargin: 1200px)
// 统一调用 loadImage（避免重复请求）
// 滚轮预测性预加载（向前看 4 页）
```

#### 6. 进度持久化
```javascript
// 单画廊: localStorage[`eh-progress-${gid}`]
// 历史列表: localStorage['eh-reading-history'] (200条)
// 结构: { page, mode, scrollLeft, timestamp }
```

### 性能优化点

| 优化项 | 实现方式 | 效果 |
|--------|---------|------|
| **请求去重** | realUrlRequests Map | 避免重复解析同一页 |
| **加载复用** | imageCache Promise | 多处同时请求同一图片时复用 |
| **并发控制** | 预取队列限制 2 并发 | 减少服务器压力与 HTTP/2 错误 |
| **导航防抖** | scheduleShowPage 140ms | 快速连击只加载最终页 |
| **拖动预热** | progressBar.oninput 120ms | 松手前预加载目标页 |
| **懒加载范围** | rootMargin 600px（缩略图）/1200px（横向图片） | 提前加载减少白屏 |
| **瞬跳主动加载** | instant 模式触发 loadImage | 跳转后立即加载目标页及前后页 |
| **缩略图占位** | 固定容器 + 雪碧背景（v1.2.0） | 零延迟展示，防止布局跳动 |
| **预测性预加载** | 滚轮方向检测（v1.2.0） | 横向模式提前加载滚动方向的 4 页 |

---

## 🔧 项目结构

```
eh-reader-extension/
├── manifest.json          # 扩展配置 (Manifest V3, v1.2.0)
├── content.js            # 核心内容脚本 (2300+ 行)
│   ├── 早期脚本拦截与兜底解析
│   ├── 数据提取与缓存
│   ├── 图片加载系统
│   ├── 预取队列管理
│   ├── 缩略图系统（占位+懒加载）
│   ├── UI 渲染与事件
│   ├── 单页/横向模式
│   └── 进度记录与恢复
├── background.js         # 后台服务（预留）
├── popup.html / popup.js # 扩展弹窗（预留）
├── style/
│   └── reader.css        # 阅读器样式 (1400+ 行)
├── icons/
│   ├── icon16.png
│   ├── icon48.png
│   └── icon128.png
├── welcome.html          # 欢迎页（首次安装）
└── README.md             # 本文档
```

---

## 🎯 适用场景

✅ **自动启用**
- `https://e-hentai.org/mpv/*`
- `https://exhentai.org/mpv/*`

❌ **不影响其他页面**
- 画廊列表页
- 详情页
- 其他站点

---

## 🐛 已知问题与限制

1. **真实 URL 解析依赖 HTML 抓取**  
   目前通过 fetch `/s/` 页面解析图片 URL，未来可能接入官方 API

2. **HTTP/2 协议错误**（已大幅改善）  
   极端情况下仍可能出现，已通过并发控制、状态管理、懒加载优化减少

3. **横向模式初始加载**  
   首次进入横向模式时，IntersectionObserver 可能需要短暂时间触发懒加载

4. **网络环境敏感**  
   某些镜像服务器或不稳定网络下可能加载缓慢

---

## 🔮 路线图

### 已完成 ✅
- [x] 基础单页阅读
- [x] 横向连续模式
- [x] 智能预加载与缓存
- [x] 进度记录与自动恢复
- [x] 自动播放功能
- [x] 完美居中缩略图（v1.2.0）
- [x] 三区点击导航（v1.2.0）
- [x] 强化初始化稳定性（v1.2.0）

### 计划中 🚧
- [ ] 历史记录 UI 入口
- [ ] 自定义主题与配色
- [ ] 触摸设备手势支持
- [ ] 批量下载功能
- [ ] 键盘自定义映射
- [ ] 缩略图尺寸调节

---

## 📄 开源协议

MIT License - 自由使用、修改和分发

## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request！

**参与方式**
- 🐛 报告 Bug - 请附上浏览器版本、操作步骤、控制台日志
- 💡 功能建议 - 描述使用场景与期望行为
- 🔧 提交代码 - 遵循既有代码风格，附上测试说明

## ⚠️ 免责声明

本扩展仅用于学习和研究目的，不得用于商业用途。使用本扩展时请遵守当地法律法规及 E-Hentai 站点规则。

---

**享受更流畅的阅读体验！📚✨**

*最后更新：2025-01-08*
