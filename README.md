# EH Modern Reader

> 现代化的 E-Hentai / ExHentai 阅读器浏览器扩展：双模式阅读、智能限速、进度记忆、现代 UI。

![Version](https://img.shields.io/badge/version-2.0.0-blue)
![License](https://img.shields.io/badge/license-MIT-green)
![Platform](https://img.shields.io/badge/platform-Chrome%20%7C%20Edge%20%7C%20Firefox-brightgreen)

## 📖 简介

EH Modern Reader 提供比官方 MPV 更流畅、可控、更安全的阅读体验：支持自动模式与手动画廊模式、智能请求节流避免封禁、横向连续滚动、缩略图快速跳页、阅读进度记忆与恢复。

## ✨ 核心特性

### 🚀 双模式
- **MPV 模式**：自动替换官方 MPV（进入 `/mpv/` 自动启用）
- **Gallery 模式**：在画廊页面（`/g/`）点击扩展按钮启动，无需 300 Hath

### 🎨 阅读体验
- 单页翻页 / 横向连续滚动双模式
- 图片 `width/height:100% + object-fit:contain`，小图不留空白
- 缩略图完美居中 + 批量加载可视范围，跳页顺畅
- 自动保存并恢复阅读位置、模式、滚动进度

### 🛡️ 稳定与安全
- 请求节流：3 并发 + 250ms 间隔
- 跳页滚动锁：2 秒观察锁防洪水请求
- 批量懒加载：最多 10 张/批，仅加载可视区域附近

### ⚡ 性能优化
- 预加载系统：可配置后向页数（默认 2）
- 控制并发与取消滞后请求，减少带宽浪费
- IntersectionObserver 提前 600px 触发加载

### ⌨️ 快捷键
| 操作 | 快捷键 |
|------|--------|
| 翻页 | ← → / A D / 空格 |
| 跳首页/末页 | Home / End |
| 模式切换 | H 或 S |
| 全屏 | F11 |
| 自动播放 | P |
| 面板显示/隐藏 | Esc |

## 📦 安装

### Chrome / Edge
1. 下载最新版本 ZIP：`Releases` 页面
2. 解压到本地文件夹
3. 打开 `chrome://extensions/` 或 `edge://extensions/`
4. 打开右上角“开发者模式”
5. 点击“加载已解压的扩展程序”并选择 `eh-reader-extension` 文件夹

### Firefox（临时加载）
1. 下载并解压 ZIP
2. 打开 `about:debugging#/runtime/this-firefox`
3. 选择“临时载入附加组件”并选中 `manifest.json`

> 详细安装说明见：`docs/INSTALL.md`

## 🎯 使用方法

### MPV 模式（自动）
进入任意 MPV 页面 `/mpv/` 扩展自动接管阅读器。

### Gallery 模式（手动）
1. 进入画廊页 `/g/`
2. 点击右侧“EH Modern Reader”按钮
3. 阅读器启动，支持缩略图跳转与横向模式

## ⚙️ 设置项（概览）
| 选项 | 说明 | 默认 |
|------|------|------|
| 预加载页数 | 后向预加载图片数量 (0-10) | 2 |
| 阅读模式 | 单页 / 横向连续 | 单页 |
| 自动播放间隔 | 单页模式翻页间隔 (秒) | 3 |
| 自动滚动速度 | 横向模式滚动速度 (px/帧) | 0.5 |

## ⚠️ 风控与建议
- 不要快速连续大跨度跳页，否则可能触发限速
- 出现 “Excessive request rate” 时暂停访问，稍后重试
- 建议保持默认节流配置，不手动提高并发

## 🗂️ 目录结构（精简）
```
eh-reader-extension/
├─ manifest.json
├─ background.js
├─ content.js
├─ gallery.js
├─ popup.html / popup.js
├─ welcome.html
├─ style/reader.css
├─ icons/
├─ CHANGELOG.md / README.md / LICENSE
├─ docs/        # 文档集合
└─ scripts/     # 构建与工具脚本
```

## 📝 版本历史（摘要）
- **v2.0.0**：双模式整合、横向填充优化、智能请求节流、批量缩略图加载、项目重构
完整变更参见：`CHANGELOG.md`

## �️ 开发
克隆后可直接加载文件夹；使用 `scripts/build.ps1` 重新打包发布 ZIP。

## 🤝 贡献
欢迎提交 Issue / PR 改进体验，文档位于 `docs/`。

## 📄 许可
MIT License

---
如果本项目对你有帮助，欢迎 Star ⭐ 支持！

- [故障排除](docs/TROUBLESHOOTING.md)

- [发布记录](CHANGELOG.md)```

┌────────────────────────────────────────────────────────────┐

---│  [返回] 标题            页码    [反转][自动][设置][全屏][主题] │ ← 顶部栏（可隐藏）

├────────────────────────────────────────────────────────────┤

## 🔧 项目结构│                                                            │

│                     主图片显示区域                          │

```│                                                            │

eh-reader-extension/│          单页模式：当前图片居中显示                          │

├── manifest.json         # 扩展配置│      横向连续模式：水平滚动查看所有图片                      │

├── content.js           # MPV 核心脚本 (2740+ 行)│                                                            │

├── gallery.js           # Gallery 启动脚本 (420 行)│   三区点击：左1/3翻页 ← | 中1/3切换顶栏 | → 右1/3翻页      │

├── background.js        # 后台脚本│                                                            │

├── popup.html/js        # 设置面板├────────────────────────────────────────────────────────────┤

├── welcome.html         # 欢迎页│  ┌──────────────────────────────────────────────────┐    │

├── style/reader.css     # 阅读器样式 (1450+ 行)│  │  [缩略图1] [缩略图2] [缩略图3] ... [缩略图N]      │    │ ← 底部缩略图

├── icons/               # 扩展图标│  └──────────────────────────────────────────────────┘    │    （横向滚动）

├── scripts/             # 构建脚本│  页码: 1  ══════════●══════════  485                      │ ← 进度条

├── docs/                # 文档└────────────────────────────────────────────────────────────┘

└── dist/                # 发布包```

```

### 快捷键一览

---

| 按键 | 功能 | 说明 |

## 🤝 贡献|------|------|------|

| `←` / `A` | 上一页 | 单页模式切页/横向模式平滑滚动 |

欢迎提交 Issue 和 Pull Request！| `→` / `D` / `空格` | 下一页 | 单页模式切页/横向模式平滑滚动 |

| `Home` | 跳转首页 | 立即定位到第 1 页 |

**贡献方式**：| `End` | 跳转末页 | 立即定位到最后一页 |

- 🐛 报告 Bug - 附上浏览器版本、操作步骤、控制台日志| `P` | 自动播放 | 切换自动翻页/滚动 |

- 💡 功能建议 - 描述使用场景与期望效果| `F11` | 全屏 | 进入/退出全屏模式 |

- 🔧 提交代码 - 遵循代码风格，附上测试说明| `Esc` | 关闭面板 | 关闭设置面板/退出全屏 |



---### 鼠标/触控操作



## 📄 开源协议#### 三区点击导航（v1.2.0 新增）

- **点击左侧 1/3** - 向左翻页

[MIT License](LICENSE) - 自由使用、修改和分发- **点击中间 1/3** - 切换顶栏显示/隐藏

- **点击右侧 1/3** - 向右翻页

---- 适用于所有模式，覆盖整个视图区域



## 🔮 路线图#### 单页模式

- **滚轮上下** - 前后翻页

### v2.0.0 (当前版本) ✅- **点击缩略图** - 跳转到指定页

- Gallery 模式完整支持- **拖动进度条** - 预热目标页，松手跳转

- 请求节流与风控防护

- 横向模式UI优化#### 横向连续模式

- 项目结构规范化- **滚轮上下** - 自动映射为水平滚动 + 预测性预加载（v1.2.0 优化）

- **点击缩略图/进度条** - 瞬时跳转到目标页

### 计划中 🚧- **自然滚动** - 自动识别当前页并更新高亮

- 可配置节流参数（保守/标准/快速）

- 失败重试与错误统计面板### 设置选项

- 触摸手势支持

- 阅读历史记录UI| 选项 | 说明 | 默认值 |

|------|------|--------|

---| **预加载页数** | 向后预加载的页数（0-10） | 2 |

| **阅读模式** | 单页 / 横向连续 | 单页 |

## ⚠️ 免责声明| **自动播放间隔** | 单页模式翻页间隔（0.1-120秒） | 3s |

| **自动滚动速度** | 横向模式滚动速度（0.1-100 px/帧） | 0.5 |

本扩展仅供学习研究，请遵守当地法律法规及站点规则。作者不对使用本扩展产生的任何后果负责。

💡 **提示**：

---- 设置面板已优化为更紧凑的 360px 宽度（v1.2.0）

- Alt+单击"自动播放"按钮可快速调整间隔/速度

**享受更流畅的阅读体验！** 📚✨- 所有设置实时生效，无需刷新



*最后更新：2025-11-10*### 导航行为差异


#### 进度条与页码输入
- **单页模式** - 直接加载目标页
- **横向模式** - 瞬时跳转（无动画，立即定位并主动加载目标页及前后 1-2 页）

#### 键盘与缩略图
- **单页模式** - 逐页切换
- **横向模式** - 平滑滚动到目标位置

> 设计理念：进度条跳转追求速度，键盘/缩略图导航保持连续性

### 进度记录说明

**自动保存内容**（每个画廊独立）
- 最后阅读页码
- 当前阅读模式
- 横向模式的滚动位置
- 最后访问时间戳

**自动恢复策略**
1. 检测到已保存进度时自动恢复阅读模式
2. 横向模式优先恢复滚动位置，否则瞬跳到保存页码
3. 单页模式直接跳转到保存页码

**历史管理**
- 维护最近 200 条阅读记录（LRU）
- 存储在 localStorage（`eh-reading-history`）
- 后续版本将提供历史列表 UI

---

## 🛠️ 技术实现

### 架构设计

```
┌─────────────────────────────────────┐
│  content.js (核心逻辑)               │
│  - 早期脚本拦截与变量捕获             │
│  - 真实 URL 解析与缓存               │
│  - 图片预加载队列（并发控制）         │
│  - 双模式渲染（单页/横向连续）        │
│  - 进度记录与恢复                    │
└─────────────────────────────────────┘
         ↓ 注入时机: document_start
┌─────────────────────────────────────┐
│  E-Hentai MPV 页面                   │
│  - 拦截原始脚本执行                   │
│  - 捕获 imagelist / gid / mpvkey     │
│  - 完全重写 DOM 结构                 │
└─────────────────────────────────────┘
```

### 核心机制

#### 1. 早期脚本拦截与兜底解析（v1.2.0 强化）
```javascript
// document_start 阶段覆写 appendChild/insertBefore
// 拦截内联脚本，解析并缓存 imagelist / gid / mpvkey
// 三层兜底：早期捕获 → 延迟重试（6秒）→ fetch HTML 解析
// 阻止原版 MPV 加载
```

#### 2. 真实 URL 解析
```javascript
// /s/<hash>/<gid>-<page> → 解析 HTML → 提取图片 URL
// 缓存: realUrlCache (hash → url)
// 去重: realUrlRequests (防止重复请求)
```

#### 3. 预取队列
```javascript
// 并发上限: 2
// 可取消: AbortController
// 优先级: 进度条拖动预热 > 正常预取
// 状态管理: loaded / loading / error
```

#### 4. 缩略图系统（v1.2.0 重构）
```javascript
// 固定占位 + 雪碧图快速预览（零延迟）
// IntersectionObserver (rootMargin: 600px)
// 真实图片 Canvas 绘制（contain 缩放 + 居中）
// 加载后清除背景，替换为最终缩略图
```

#### 5. 横向模式懒加载
```javascript
// IntersectionObserver (rootMargin: 1200px)
// 统一调用 loadImage（避免重复请求）
// 滚轮预测性预加载（向前看 4 页）
```

#### 6. 进度持久化
```javascript
// 单画廊: localStorage[`eh-progress-${gid}`]
// 历史列表: localStorage['eh-reading-history'] (200条)
// 结构: { page, mode, scrollLeft, timestamp }
```

### 性能优化点

| 优化项 | 实现方式 | 效果 |
|--------|---------|------|
| **请求去重** | realUrlRequests Map | 避免重复解析同一页 |
| **加载复用** | imageCache Promise | 多处同时请求同一图片时复用 |
| **并发控制** | 预取队列限制 2 并发 | 减少服务器压力与 HTTP/2 错误 |
| **导航防抖** | scheduleShowPage 140ms | 快速连击只加载最终页 |
| **拖动预热** | progressBar.oninput 120ms | 松手前预加载目标页 |
| **懒加载范围** | rootMargin 600px（缩略图）/1200px（横向图片） | 提前加载减少白屏 |
| **瞬跳主动加载** | instant 模式触发 loadImage | 跳转后立即加载目标页及前后页 |
| **缩略图占位** | 固定容器 + 雪碧背景（v1.2.0） | 零延迟展示，防止布局跳动 |
| **预测性预加载** | 滚轮方向检测（v1.2.0） | 横向模式提前加载滚动方向的 4 页 |

---

## 🔧 项目结构

```
eh-reader-extension/
├── manifest.json          # 扩展配置 (Manifest V3)
├── content.js            # MPV 模式核心脚本 (2700+ 行)
├── gallery.js            # Gallery 模式启动脚本 (420 行)
├── background.js         # 后台脚本
├── popup.html/js         # 设置面板
├── welcome.html          # 欢迎页面
├── style/
│   └── reader.css        # 阅读器样式 (1440+ 行)
├── icons/                # 扩展图标
├── scripts/              # 构建和工具脚本
│   ├── build.ps1         # 打包发布
│   ├── generate-icons.ps1
│   └── ...
├── docs/                 # 文档目录
│   ├── INSTALL.md
│   ├── DEVELOPMENT.md
│   ├── TROUBLESHOOTING.md
│   └── ...
├── dist/                 # 发布包
│   └── eh-modern-reader-v1.3.0.zip
├── README.md
├── CHANGELOG.md
├── RELEASE_NOTES.md
└── LICENSE
```
---

## 📚 文档

- **安装指南**: [docs/INSTALL.md](docs/INSTALL.md)
- **开发文档**: [docs/DEVELOPMENT.md](docs/DEVELOPMENT.md)
- **故障排除**: [docs/TROUBLESHOOTING.md](docs/TROUBLESHOOTING.md)
- **发布指南**: [docs/PUBLISH_GUIDE.md](docs/PUBLISH_GUIDE.md)

---

## 🎯 适用场景

✅ **自动启用**
- MPV 模式: `https://e-hentai.org/mpv/*` 或 `https://exhentai.org/mpv/*`
- Gallery 模式: `https://e-hentai.org/g/*` 或 `https://exhentai.org/g/*` (点击启动按钮)

❌ **不影响其他页面**
- 画廊列表页
- 其他站点

---

## ⚠️ 重要提示

**Gallery 模式风控说明**：
- 使用 Gallery 模式时，扩展会自动限制请求频率（3并发 + 250ms间隔）
- 大幅跳页时会锁定观察器2秒，手动加载可视区域缩略图（最多10张）
- 如仍遇到"Excessive request rate"错误，请等待解封后使用，或降低使用频率

---

## 🐛 已知限制

1. **Gallery 模式需手动启动** - 在画廊页面点击"EH Modern Reader"按钮
2. **首次加载较慢** - 需要解析 HTML 获取图片 URL
3. **网络环境敏感** - 不稳定网络可能导致加载缓慢

---

## 🔮 路线图

### v1.3.0 ✅
- [x] Gallery 模式支持
- [x] 请求节流与风控防护
- [x] 横向模式间距优化
- [x] 跳页缩略图批量加载

### 计划中 🚧
- [ ] 配置化节流参数（保守/标准/快速模式）
- [ ] 失败重试机制与错误统计面板
- [ ] 触摸设备手势支持
- [ ] 历史记录 UI

---

## 📄 开源协议

MIT License - 自由使用、修改和分发

## 🤝 贡献指南

欢迎提交 Issue 和 Pull Request！

**参与方式**
- 🐛 报告 Bug - 请附上浏览器版本、操作步骤、控制台日志
- 💡 功能建议 - 描述使用场景与期望行为
- 🔧 提交代码 - 遵循既有代码风格，附上测试说明

## ⚠️ 免责声明

本扩展仅用于学习和研究目的，不得用于商业用途。使用本扩展时请遵守当地法律法规及 E-Hentai 站点规则。

---

**享受更流畅的阅读体验！📚✨**

*最后更新：2025-11-10*
