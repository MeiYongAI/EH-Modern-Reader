# Changelog

All notable changes to EH Modern Reader will be documented in this file.

The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

## [1.2.0] - 2025-01-09

### ✨ 新增

#### 🖼️ 缩略图系统重构
- **固定占位容器** - 每个缩略图初始即创建 100×142 固定尺寸容器，防止布局跳动
- **雪碧图快速预览** - 利用站点原始 MPV 雪碧图作为即时背景，零延迟展示
- **真实图片缩略图** - 独立获取每页真实图片，Canvas 绘制，contain 缩放 + 完美居中
- **垂直水平双向居中** - 彻底消除顶部空白，缩略图完全居中展示（参考 JHenTai）
- **智能懒加载优化** - IntersectionObserver rootMargin 扩大到 600px，提前触发加载

#### 🖱️ 交互增强
- **三区点击导航** - 全新点击区域划分
  - 左侧 1/3：向左翻页
  - 中间 1/3：切换顶栏显示/隐藏
  - 右侧 1/3：向右翻页
  - 适用所有模式，覆盖整个视图区域
- **预测性预加载** - 横向模式滚轮操作时检测滚动方向，提前加载前方 4 页

#### 🛡️ 稳定性增强
- **三层兜底初始化** - 解决"无法加载图片列表"问题
  1. 早期脚本拦截变量捕获
  2. 延迟重试（等待时间从 3 秒延长到 6 秒）
  3. HTTP 回退：直接抓取页面 HTML 并解析 `imagelist`
- **CORS 优化** - 避免 Canvas 污染，直接插入 Canvas 节点而非导出 dataURL

### 🎨 改进

#### UI/UX
- **收窄设置面板** - 最大宽度从 420px 调整到 360px，更紧凑适合小屏设备
- **设置面板内边距优化** - 从 20px/24px 减少到 18px/20px
- **响应式宽度** - 从 90% 调整到 92%

#### 性能
- **缩略图加载策略** - 首屏即刻展示雪碧图预览，异步加载真实图片
- **预取并发控制** - 维持 2 并发上限，避免服务器压力
- **缓存复用** - realUrlCache 和 imageCache 避免重复请求

### 🐛 修复
- 缩略图顶部空白问题（雪碧图单元格内置留白）
- 初始化时偶发"无法加载图片列表"警告
- Canvas SecurityError: Tainted canvases may not be exported
- 缩略图跳转后位置错误（因为之前未加载导致容器高度为0）
- 设置弹窗在小屏设备上过宽

### 🔧 技术改进
- 缩略图系统从雪碧图背景定位切换到独立 Canvas 渲染
- 延长初始化等待时间并增加 fallback 机制
- 移除缩略图 dataURL 导出，直接使用 Canvas 节点

---

## [1.1.0] - 2025-01-08

### ✨ 新增
- **横向连续模式** - 全新水平滚动阅读模式
  - 自动检测当前页并更新高亮
  - 滚轮垂直映射为水平滚动
  - 瞬时跳转 vs 平滑滚动策略
  - 自动播放支持（持续滚动）
- **智能预加载系统**
  - 可配置预加载页数（0-10页）
  - 并发控制（最多 2 个并发请求）
  - 防抖机制与请求取消
  - 进度条拖动预热
- **反向阅读支持** - 一键切换左右阅读方向
- **自动播放功能**
  - 单页模式：定时翻页（0.1-120秒）
  - 横向模式：持续滚动（0.1-100 px/帧）
  - Alt+单击快速设置参数

### 🎨 改进
- 深色/浅色主题自动适配（根据 prefers-color-scheme）
- 进度条两端显示页码（当前页/总页数）
- 进度条滑块交互优化
- 缩略图容器高度增加到 160px
- 底部菜单布局优化

### 🐛 修复
- 横向模式初始化时的滚动定位
- 进度记录与恢复逻辑
- 预取队列竞态条件
- 缩略图高亮同步问题

---

## [1.0.0] - 2025-01-07

### ✨ 首次发布
- **现代化阅读器界面** - 完全替代原版 MPV
- **单页阅读模式** - 流畅的图片加载与翻页
- **深色模式** - 护眼的夜间阅读主题
- **进度记忆** - 自动保存每个画廊的阅读位置
- **缩略图导航** - 快速预览与跳转
- **键盘快捷键** - ← → Home End F11 Esc
- **鼠标操作** - 点击左右翻页，点击缩略图跳转
- **滚轮翻页** - 向下滚动自动翻页
- **进度条控制** - 拖动快速跳转
- **全屏支持** - F11 进入/退出全屏
- **响应式布局** - 适配各种屏幕尺寸
- **历史记录** - 维护最近 200 条阅读记录（localStorage）

### 🔧 技术实现
- Manifest V3 扩展
- document_start 早期脚本拦截
- 完全重写 DOM 结构
- 真实图片 URL 解析与缓存
- 图片预加载队列
- IntersectionObserver 懒加载
- localStorage 进度持久化

---

## [Unreleased]

### 计划中
- [ ] 历史记录 UI 入口
- [ ] 自定义主题与配色
- [ ] 触摸设备手势支持
- [ ] 批量下载功能
- [ ] 键盘自定义映射
- [ ] 缩略图尺寸调节

---

[1.2.0]: https://github.com/MeiYongAI/EH-Modern-Reader/releases/tag/v1.2.0
[1.1.0]: https://github.com/MeiYongAI/EH-Modern-Reader/releases/tag/v1.1.0
[1.0.0]: https://github.com/MeiYongAI/EH-Modern-Reader/releases/tag/v1.0.0
